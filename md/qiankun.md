## qiankun

ä»‹ç»
qiankun æ˜¯ä¸€ä¸ªåŸºäº single-spa çš„å¾®å‰ç«¯å®ç°åº“ï¼Œæ—¨åœ¨å¸®åŠ©å¤§å®¶èƒ½æ›´ç®€å•ã€æ— ç—›çš„æ„å»ºä¸€ä¸ªç”Ÿäº§å¯ç”¨å¾®å‰ç«¯æ¶æ„ç³»ç»Ÿã€‚

qiankun å­µåŒ–è‡ªèš‚èšé‡‘èç§‘æŠ€åŸºäºå¾®å‰ç«¯æ¶æ„çš„äº‘äº§å“ç»Ÿä¸€æ¥å…¥å¹³å°ï¼Œåœ¨ç»è¿‡ä¸€æ‰¹çº¿ä¸Šåº”ç”¨çš„å……åˆ†æ£€éªŒåŠæ‰“ç£¨åï¼Œæˆ‘ä»¬å°†å…¶å¾®å‰ç«¯å†…æ ¸æŠ½å–å‡ºæ¥å¹¶å¼€æºï¼Œå¸Œæœ›èƒ½åŒæ—¶å¸®åŠ©ç¤¾åŒºæœ‰ç±»ä¼¼éœ€æ±‚çš„ç³»ç»Ÿæ›´æ–¹ä¾¿çš„æ„å»ºè‡ªå·±çš„å¾®å‰ç«¯ç³»ç»Ÿï¼ŒåŒæ—¶ä¹Ÿå¸Œæœ›é€šè¿‡ç¤¾åŒºçš„å¸®åŠ©å°† qiankun æ‰“ç£¨çš„æ›´åŠ æˆç†Ÿå®Œå–„ã€‚

ç›®å‰ qiankun å·²åœ¨èš‚èšå†…éƒ¨æœåŠ¡äº†è¶…è¿‡ 200+ çº¿ä¸Šåº”ç”¨ï¼Œåœ¨æ˜“ç”¨æ€§åŠå®Œå¤‡æ€§ä¸Šï¼Œç»å¯¹æ˜¯å€¼å¾—ä¿¡èµ–çš„ã€‚

ä»€ä¹ˆæ˜¯å¾®å‰ç«¯
Techniques, strategies and recipes for building a modern web app with multiple teams that can ship features independently. -- Micro Frontends

å¾®å‰ç«¯æ˜¯ä¸€ç§å¤šä¸ªå›¢é˜Ÿé€šè¿‡ç‹¬ç«‹å‘å¸ƒåŠŸèƒ½çš„æ–¹å¼æ¥å…±åŒæ„å»ºç°ä»£åŒ– web åº”ç”¨çš„æŠ€æœ¯æ‰‹æ®µåŠæ–¹æ³•ç­–ç•¥ã€‚

å¾®å‰ç«¯æ¶æ„å…·å¤‡ä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒä»·å€¼ï¼š

æŠ€æœ¯æ ˆæ— å…³
ä¸»æ¡†æ¶ä¸é™åˆ¶æ¥å…¥åº”ç”¨çš„æŠ€æœ¯æ ˆï¼Œå¾®åº”ç”¨å…·å¤‡å®Œå…¨è‡ªä¸»æƒ

ç‹¬ç«‹å¼€å‘ã€ç‹¬ç«‹éƒ¨ç½²
å¾®åº”ç”¨ä»“åº“ç‹¬ç«‹ï¼Œå‰åç«¯å¯ç‹¬ç«‹å¼€å‘ï¼Œéƒ¨ç½²å®Œæˆåä¸»æ¡†æ¶è‡ªåŠ¨å®ŒæˆåŒæ­¥æ›´æ–°

å¢é‡å‡çº§

åœ¨é¢å¯¹å„ç§å¤æ‚åœºæ™¯æ—¶ï¼Œæˆ‘ä»¬é€šå¸¸å¾ˆéš¾å¯¹ä¸€ä¸ªå·²ç»å­˜åœ¨çš„ç³»ç»Ÿåšå…¨é‡çš„æŠ€æœ¯æ ˆå‡çº§æˆ–é‡æ„ï¼Œè€Œå¾®å‰ç«¯æ˜¯ä¸€ç§éå¸¸å¥½çš„å®æ–½æ¸è¿›å¼é‡æ„çš„æ‰‹æ®µå’Œç­–ç•¥

ç‹¬ç«‹è¿è¡Œæ—¶
æ¯ä¸ªå¾®åº”ç”¨ä¹‹é—´çŠ¶æ€éš”ç¦»ï¼Œè¿è¡Œæ—¶çŠ¶æ€ä¸å…±äº«

å¾®å‰ç«¯æ¶æ„æ—¨åœ¨è§£å†³å•ä½“åº”ç”¨åœ¨ä¸€ä¸ªç›¸å¯¹é•¿çš„æ—¶é—´è·¨åº¦ä¸‹ï¼Œç”±äºå‚ä¸çš„äººå‘˜ã€å›¢é˜Ÿçš„å¢å¤šã€å˜è¿ï¼Œä»ä¸€ä¸ªæ™®é€šåº”ç”¨æ¼”å˜æˆä¸€ä¸ªå·¨çŸ³åº”ç”¨(Frontend Monolith)åï¼Œéšä¹‹è€Œæ¥çš„åº”ç”¨ä¸å¯ç»´æŠ¤çš„é—®é¢˜ã€‚è¿™ç±»é—®é¢˜åœ¨ä¼ä¸šçº§ Web åº”ç”¨ä¸­å°¤å…¶å¸¸è§ã€‚

æ›´å¤šå…³äºå¾®å‰ç«¯çš„ç›¸å…³ä»‹ç»ï¼Œæ¨èå¤§å®¶å¯ä»¥å»çœ‹è¿™å‡ ç¯‡æ–‡ç« ï¼š

Micro Frontends
Micro Frontends from martinfowler.com
å¯èƒ½æ˜¯ä½ è§è¿‡æœ€å®Œå–„çš„å¾®å‰ç«¯è§£å†³æ–¹æ¡ˆ
å¾®å‰ç«¯çš„æ ¸å¿ƒä»·å€¼
qiankun çš„æ ¸å¿ƒè®¾è®¡ç†å¿µ
ğŸ¥„ ç®€å•

ç”±äºä¸»åº”ç”¨å¾®åº”ç”¨éƒ½èƒ½åšåˆ°æŠ€æœ¯æ ˆæ— å…³ï¼Œqiankun å¯¹äºç”¨æˆ·è€Œè¨€åªæ˜¯ä¸€ä¸ªç±»ä¼¼ jQuery çš„åº“ï¼Œä½ éœ€è¦è°ƒç”¨å‡ ä¸ª qiankun çš„ API å³å¯å®Œæˆåº”ç”¨çš„å¾®å‰ç«¯æ”¹é€ ã€‚åŒæ—¶ç”±äº qiankun çš„ HTML entry åŠæ²™ç®±çš„è®¾è®¡ï¼Œä½¿å¾—å¾®åº”ç”¨çš„æ¥å…¥åƒä½¿ç”¨ iframe ä¸€æ ·ç®€å•ã€‚

ğŸ¡ è§£è€¦/æŠ€æœ¯æ ˆæ— å…³

å¾®å‰ç«¯çš„æ ¸å¿ƒç›®æ ‡æ˜¯å°†å·¨çŸ³åº”ç”¨æ‹†è§£æˆè‹¥å¹²å¯ä»¥è‡ªæ²»çš„æ¾è€¦åˆå¾®åº”ç”¨ï¼Œè€Œ qiankun çš„è¯¸å¤šè®¾è®¡å‡æ˜¯ç§‰æŒè¿™ä¸€åŸåˆ™ï¼Œå¦‚ HTML entryã€æ²™ç®±ã€åº”ç”¨é—´é€šä¿¡ç­‰ã€‚è¿™æ ·æ‰èƒ½ç¡®ä¿å¾®åº”ç”¨çœŸæ­£å…·å¤‡ ç‹¬ç«‹å¼€å‘ã€ç‹¬ç«‹è¿è¡Œ çš„èƒ½åŠ›ã€‚

å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„
TODO

ä¸ºä»€ä¹ˆä¸æ˜¯ iframe
çœ‹è¿™é‡Œ Why Not Iframe

ç‰¹æ€§
ğŸ“¦ åŸºäº single-spa å°è£…ï¼Œæä¾›äº†æ›´åŠ å¼€ç®±å³ç”¨çš„ APIã€‚
ğŸ“± æŠ€æœ¯æ ˆæ— å…³ï¼Œä»»æ„æŠ€æœ¯æ ˆçš„åº”ç”¨å‡å¯ ä½¿ç”¨/æ¥å…¥ï¼Œä¸è®ºæ˜¯ React/Vue/Angular/JQuery è¿˜æ˜¯å…¶ä»–ç­‰æ¡†æ¶ã€‚
ğŸ’ª HTML Entry æ¥å…¥æ–¹å¼ï¼Œè®©ä½ æ¥å…¥å¾®åº”ç”¨åƒä½¿ç”¨ iframe ä¸€æ ·ç®€å•ã€‚
ğŸ›¡â€‹ æ ·å¼éš”ç¦»ï¼Œç¡®ä¿å¾®åº”ç”¨ä¹‹é—´æ ·å¼äº’ç›¸ä¸å¹²æ‰°ã€‚
ğŸ§³ JS æ²™ç®±ï¼Œç¡®ä¿å¾®åº”ç”¨ä¹‹é—´ å…¨å±€å˜é‡/äº‹ä»¶ ä¸å†²çªã€‚
âš¡ï¸ èµ„æºé¢„åŠ è½½ï¼Œåœ¨æµè§ˆå™¨ç©ºé—²æ—¶é—´é¢„åŠ è½½æœªæ‰“å¼€çš„å¾®åº”ç”¨èµ„æºï¼ŒåŠ é€Ÿå¾®åº”ç”¨æ‰“å¼€é€Ÿåº¦ã€‚
ğŸ”Œ umi æ’ä»¶ï¼Œæä¾›äº† @umijs/plugin-qiankun ä¾› umi åº”ç”¨ä¸€é”®åˆ‡æ¢æˆå¾®å‰ç«¯æ¶æ„ç³»ç»Ÿã€‚

#### qiankun å®æˆ˜

##### 1.æ–°å»ºé¡¹ç›®

```
vue create qiankun-base
vue create qiankun-vue
npx create-react-app antd-demo

```

#### 2.qiankun-base é‡Œé¢å®‰è£… qiankun

ä¿®æ”¹ä¸»æ–‡ä»¶ä»¥åŠä¿®æ”¹ä¸€ä¸‹ç«¯å£

```
 <div id="app">
    <el-menu :router="true" mode="horizontal">
      <el-menu-item index="/">home</el-menu-item>
      <el-menu-item index="/vue">vueåº”ç”¨</el-menu-item>
      <el-menu-item index="/react">reactåº”ç”¨</el-menu-item>
    </el-menu>
    <router-view />
    <div id="vue"></div>
    <div id="react"></div>
  </div>
```

```
import { registerMicroApps, start } from 'qiankun';
const apps = [
  {
    name: 'vueapp', // app name registered
    entry: '//localhost:10000',//é»˜è®¤ä¼šåŠ è½½html è§£æé‡Œé¢js åŠ¨æ€æ‰§è¡Œ å­åº”ç”¨å¿…é¡»æ”¯æŒè·¨åŸŸ
    container: '#vue',//æŒ‚è½½åˆ°vueä¸Š
    activeRule: '/vue',//è®¿é—®vueè¢«æ¿€æ´»
  },
  {
    name: 'reactapp',
    entry: '//localhost:20000',
    container: '#react',
    activeRule: '/react',
  },
]
registerMicroApps(apps);//æ³¨å†Œåº”ç”¨

start();//å¼€å¯
```

#### 3.qiankun-vue æ–‡ä»¶ä¿®æ”¹

ä¿®æ”¹ router é¢å¤–çš„è·¯å¾„

```
const router = createRouter({
  history: createWebHistory('/vue'),
  routes
})

export default router
```

å¤„ç† main.js

```
import {
    createApp
} from 'vue'
import App from './App.vue'
import router from './router'
import store from './store'

let instance = null; //å®šä¹‰ä¸€ä¸ªå®ä¾‹
function render(props) {
    instance = createApp(App)
    instance.use(store).use(router).mount('#app')
}
// ä½¿ç”¨ webpack è¿è¡Œæ—¶ publicPath é…ç½®
//qiankun å°†ä¼šåœ¨å¾®åº”ç”¨ bootstrap ä¹‹å‰æ³¨å…¥ä¸€ä¸ªè¿è¡Œæ—¶çš„ publicPath å˜é‡ï¼Œä½ éœ€è¦åšçš„æ˜¯åœ¨å¾®åº”ç”¨çš„ entry js çš„é¡¶éƒ¨æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š
if (window.__POWERED_BY_QIANKUN__) {
    __webpack_public_path__ = window.__INJECTED_PUBLIC_PATH_BY_QIANKUN__;
}
if (!window.__POWERED_BY_QIANKUN__) {
    //å¦‚æœç‹¬ç«‹è¿è¡Œ
    render();
}
//å­ç»„ä»¶å¾—åè®®
/**
 * bootstrap åªä¼šåœ¨å¾®åº”ç”¨åˆå§‹åŒ–çš„æ—¶å€™è°ƒç”¨ä¸€æ¬¡ï¼Œä¸‹æ¬¡å¾®åº”ç”¨é‡æ–°è¿›å…¥æ—¶ä¼šç›´æ¥è°ƒç”¨ mount é’©å­ï¼Œä¸ä¼šå†é‡å¤è§¦å‘ bootstrapã€‚
 * é€šå¸¸æˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œåšä¸€äº›å…¨å±€å˜é‡çš„åˆå§‹åŒ–ï¼Œæ¯”å¦‚ä¸ä¼šåœ¨ unmount é˜¶æ®µè¢«é”€æ¯çš„åº”ç”¨çº§åˆ«çš„ç¼“å­˜ç­‰ã€‚
 */
export async function bootstrap() {
    console.log('react app bootstraped');
}

/**
 * åº”ç”¨æ¯æ¬¡è¿›å…¥éƒ½ä¼šè°ƒç”¨ mount æ–¹æ³•ï¼Œé€šå¸¸æˆ‘ä»¬åœ¨è¿™é‡Œè§¦å‘åº”ç”¨çš„æ¸²æŸ“æ–¹æ³•
 */
export async function mount(props) {
    render(props)
    //éœ€è¦è®¾ç½®ä¸€ä¸‹å…¨å±€çš„å±æ€§
    instance.config.globalProperties.$onGlobalStateChange =
    props.onGlobalStateChange;
  instance.config.globalProperties.$setGlobalState = props.setGlobalState;
}

/**
 * åº”ç”¨æ¯æ¬¡ åˆ‡å‡º/å¸è½½ ä¼šè°ƒç”¨çš„æ–¹æ³•ï¼Œé€šå¸¸åœ¨è¿™é‡Œæˆ‘ä»¬ä¼šå¸è½½å¾®åº”ç”¨çš„åº”ç”¨å®ä¾‹
 */
export async function unmount(props) {
    instance.unmount();
    instance._container.innerHTML = "";
    instance = null;
}

/**
 * å¯é€‰ç”Ÿå‘½å‘¨æœŸé’©å­ï¼Œä»…ä½¿ç”¨ loadMicroApp æ–¹å¼åŠ è½½å¾®åº”ç”¨æ—¶ç”Ÿæ•ˆ
 */
export async function update(props) {
    console.log('update props', props);
}
```

é…ç½® config.js

```
module.exports = {
  devServer: {
    port: 10000,
    disableHostCheck: true,
    headers:{
      'Access-Control-Allow-Origin':'*'
    }

  },
  configureWebpack: {
    output: {
      library: 'vueapp',
      libraryTarget: 'umd',
    }
  },
};
```

#### 4.react æ–‡ä»¶ä¿®æ”¹

é…ç½® index.js

```
import React from 'react';
import ReactDOM from 'react-dom';
import './index.css';
import App from './App';
// import reportWebVitals from './reportWebVitals';

function render() {
  ReactDOM.render(
    <React.StrictMode>
      <App />
    </React.StrictMode>,
    document.getElementById('root')
  );

}
if (!window.__POWERED_BY_QIANKUN__) {
  //å¦‚æœç‹¬ç«‹è¿è¡Œ
  render();
}
export async function bootstrap() {
  console.log('react app bootstraped');
}
export async function mount() {
  render()
}
export async function unmount(props) {
  await ReactDOM.unmountComponentAtNode(document.getElementById('root'))
}

```

å¼•å…¥ react-app-rewired æ’ä»¶
react-app-rewired é‡æ–°é…ç½®æ–‡ä»¶

```
$ npm install react-app-rewired
```

ä¿®æ”¹ package.json é‡Œçš„å¯åŠ¨é…ç½®

```
"scripts": {
    "start": "react-app-rewired start",
    "build": "react-app-rewired build",
    "test": "react-app-rewired test",
  },
```

å¦‚æœéœ€è¦åœ¨é¡¹ç›®ä¸­é…ç½®ä¸€äº› webpack é…ç½®ï¼Œéœ€è¦åœ¨æ ¹ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªåç§°ä¸º config-overrides.js çš„æ–‡ä»¶

```
const { name } = require('./package.json');
module.exports = {
  webpack: function override(config, env) {
    config.entry = config.entry.filter(
      (e) => !e.includes('webpackHotDevClient')
    );
    config.output.library = `${name}-[name]`;
    config.output.libraryTarget = 'umd'; //å¯¼å‡ºumdç±»å‹
    config.output.jsonpFunction = `webpackJsonp_${name}`;
    config.output.publicPath = 'http://localhost:20000/'
    return config;
  },
  devServer: (configFunction) => {
    return function (proxy, allowedHost) {
      const config = configFunction(proxy, allowedHost);
      config.open = false;
      config.hot = false;
      config.headers = {
        'Access-Control-Allow-Origin': '*',//è·¨åŸŸ
      };
      // Return your customised Webpack Development Server config.
      return config;
    };
  },
};
```

react é…ç½®ç«¯å£

```
PORT=20000
WDS_SOCKET_PORT=20000
```

#### 5.é—®é¢˜

       5.1reactç‰ˆæœ¬é—®é¢˜
       5.2reacté…ç½®ç«¯å£

#### 6.é€šä¿¡
ä¸»åº”ç”¨ä¸­åˆ›å»ºä¸€ä¸ª actions
```
import { initGlobalState } from "qiankun";
import store from "./store";

const initialState = {
  //è¿™é‡Œå†™åˆå§‹åŒ–æ•°æ®

};

// åˆå§‹åŒ– state
const actions = initGlobalState(initialState);
actions.onGlobalStateChange((state, prev) => {//ç›‘å¬å…¬å…±çŠ¶æ€çš„å˜åŒ–
  console.log("ä¸»åº”ç”¨: å˜æ›´å‰");
  console.log(prev);
  console.log("ä¸»åº”ç”¨: å˜æ›´å");
  console.log(state);
  // store.commit('common/globalInfo',state);//è¿™é‡Œæˆ‘æŠŠå…¬å…±çŠ¶æ€å­˜åˆ°ä¸»åº”ç”¨çš„vuexé‡Œäº†
});
// actions.setGlobalState(initialState);
// actions.offGlobalStateChange();

export default actions;

```
é¡µé¢ä¸­ç›‘å¬
```
  // æ³¨å†Œä¸€ä¸ªè§‚å¯Ÿè€…å‡½æ•°
    actions.onGlobalStateChange((state, prevState) => {
      // state: å˜æ›´åçš„çŠ¶æ€; prevState: å˜æ›´å‰çš„çŠ¶æ€
      console.log("ä¸»åº”ç”¨è§‚å¯Ÿè€…ï¼štoken æ”¹å˜å‰çš„å€¼ä¸º ", prevState);
      console.log(
        "ä¸»åº”ç”¨è§‚å¯Ÿè€…ï¼šç™»å½•çŠ¶æ€å‘ç”Ÿæ”¹å˜ï¼Œæ”¹å˜åçš„ token çš„å€¼ä¸º ",
        state
      );
    });
```
vue å­åº”ç”¨ 
```
export async function mount(props) {
    render(props)
     // è®¾ç½®é€šè®¯
     instance.config.globalProperties.$onGlobalStateChange = props.onGlobalStateChange
     instance.config.globalProperties.$setGlobalState = props.setGlobalState
}
```
å­åº”ç”¨çš„ç›‘å¬
```
   this.$onGlobalStateChange((state) => {
      //ç›‘å¬å…¨å±€çŠ¶æ€
      console.log("å­åº”ç”¨çš„ç›‘å¬");
      console.log(state);
    }, true);
```
å­åº”ç”¨çš„æäº¤
```
 this.$setGlobalState({ token: "qiankun" }); //æ”¹å˜å…¨å±€çŠ¶æ€
```
